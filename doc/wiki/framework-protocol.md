# Function-Protocol Framework Protocol
## Background and Introduction
This page describe the byte level details of the SAFRN1 framework's network protocol.
It uses the same _Analyst_, _Dataowner_, _Dealer_, and _Recipient_ participant language as [design document](/doc/wiki/design.md).
However it adds a client/server aspect as described [here](/doc/wiki/design/detail.md#safrn-executable-invocation).
 - **Client**:
   - _Analyst_
 - **Server**:
   - _Dataowner_
   - _Dealer_
   - _Recipient_

This protocol is broken into two phases, the **Initialization** phase and the **Execution** Phase.
The initialization phase will distribute a query to all parties, and the execution phase will find a result for that query by executing function protocols.

## Query Initialization
Briefly, during this phase, a client (_Analyst_) will send a message with the query to one of the servers, whom we will call the proxy.
At the moment we are enforcing the proxy be the _Dealer_.
The proxy will send that query to all remaining servers, who then send greeting messages to each other.
Three types of messages sent:
 1. client to proxy (delivery)
 2. proxy to all other servers (distribution)
 3. all other servers pairwise (greeting)

The distribution and greeting messages will form "keep-alive" connections which are reused through the **Execution** phase.
the delivery message ends when the client is finished sending the query.

### Delivery
The format of the delivery message is as follows.

 - 1 byte: ``<<enum>>`` constant 0x00, indicating it is a client delivery message.
 - 16 bytes: ``<<dbuid>>`` the Session ID ([DBUID](/doc/wiki/json-schemas/dbuid.md)).
 - 16 bytes: ``<<dbuid>>`` the Organization ID of the _Analyst_ ([DBUID](/doc/wiki/json-schemas/dbuid.md)).
 - 8 bytes: ``<<integer>>`` Query ID, attempted to be unique amongst queries generated by the same _Analyst_ organization.
 - 4 bytes: ``<<integer>>`` Query length in bytes.
 - n bytes: ``<<json>>`` Query in JSON.

Total length of message (for reference only): 45 byte header with n byte query.

### Distribution
The distribution message is formatted as follows.

 - 1 byte: ``<<enum>>`` constant 0x01 indicates it is an server distribution message.
 - 16 bytes: ``<<dbuid>>`` Session ID is [DBUID](/doc/wiki/json-schemas/dbuid.md).
 - 16 bytes: ``<<dbuid>>`` The _Analyst's_ organization ID ([DBUID](/doc/wiki/json-schemas/dbuid.md)).
 - 8 bytes: ``<<integer>>`` integerQuery ID, a sequence assigned by a given analyst.
 - 16 bytes: ``<<dbuid>>`` sender ID: the Organization ID of the server who sent the initialization ([DBUID](/doc/wiki/json-schemas/dbuid.md)).
 - 4 bytes: ``<<integer>>``Length of query.
 - n bytes: ``<<json>>`` Query in JSON.

Total length of message (for reference only): 61 byte header with n byte query.

### Greeting
Each non-proxy server will send a greeting to each other non-proxy server who has an organization ID greater than its own.
Note, the organization IDs of other servers are known ahead of time from the [session config](/doc/wiki/json-schemas/session-config.md).
The greeting message is as follows.

 - 1 byte: ``<<enum>>`` constant 0x02 inticates it is a pairwise greeting message.
 - 16 bytes: ``<<dbuid>>`` Session ID is [DBUID](/doc/wiki/json-schemas/dbuid.md).
 - 16 bytes: ``<<dbuid>>`` The _Analyst's_ organization ID ([DBUID](/doc/wiki/json-schemas/dbuid.md)).
 - 8 bytes: ``<<integer>>`` Query ID, a sequence assigned by a given analyst.
 - 16 bytes: ``<<dbuid>>`` sender ID: the Organization ID of the server who sent the initialization ([DBUID](/doc/wiki/json-schemas/dbuid.md)).

Total length of message: 57 bytes exactly.

## Execution Stage
This section is expected to change.

When a server has established a connection with all participating servers, It may move on to the next phase.
Note that a server may recieve connections or even fronctocol messages before its session is completely established.
In this case it should cache all necessary data until it is useful.

### Execution Header
Each message of the execution phase will have the following header.

 - 8 bytes: ``<<integer>>`` Fronctocol ID of the intended recipient fronctocol.
 - 1 byte: ``<<enum>>`` control block
 - 4 bytes: ``<<integer>>`` message length

### Transition from Initialization to Execution

Upon establishing connections with all peers, a server will begin executing a special "root fronctocol".
The root function will begin querying the database, and exchange peerwise ready signals with other peers and other tasks to be determined.

All fronctocols have an unique ID used to map a message into the froncotocol.
The ID is generated sequentially within a query, and root fronctocol will have ID=0, and will implicitly be peers with the root fronctocol on all other servers.

### Fronctocol Synchronization and Overhead

Because the system will be creating and completing fronctocols willy nilly, messages need to be exchanged indicating their creation and completion.
It is expected that a new Fronctocol on one server will be matched by a partner on each peer server, and where multiple Fronctocols of the same type and with the same peer-set are involved, they should be declared in the same order.
In an n-party environment, a server may make differing numbers of fronctocols with different servers.
A fronctocol on one server may not have the same ID as its partner on another server.

When a fronctocol is created the following message is sent to each participant in the fronctocol.

 - 13 bytes: [execution header](#execution-header), control block is 0x00, and the fronctocol ID is that of the creator fronctocol.
 - 8 bytes: ``<<integer>>`` fronctocol ID for the newly created fronctocol.
 - 2 bytes: ``<<large enum>>`` fronctocol type code (This should be an enum or something in code).
 - n*16 bytes: ``<< list<dbuid> >>`` sorted list of organizationIds ([DBUID](/doc/wiki/json-schemas/dbuid.md)) who participate in the fronctocol.

After syncrhonization, fronctocols can exchange messages, each carrying a payload.

 - 13 byte: [execution header](#execution-header), control block is 0x01.
 - n bytes: ``<<blob>>`` of payload.

Upon completion of a fronctocol, the following completion message is sent.

 - 13 byte: [execution header](#execution-header), control block is 0x02, length is 0.
